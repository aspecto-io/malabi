

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> telemetry-repository/src/TelemetryRepository.ts</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
                <div class="search-wrapper">
                    <input id="search" type="text" placeholder="Search docs..." class="input">
                </div>
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="SpansRepository.html">SpansRepository</a></li><li><a href="TelemetryRepository.html">TelemetryRepository</a></li></ul></div><div class="category"><h2>Main Functions</h2><h3>Global</h3><ul><li><a href="global.html#clearRemoteTelemetry">clearRemoteTelemetry</a></li><li><a href="global.html#fetchRemoteTelemetry">fetchRemoteTelemetry</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>telemetry-repository/src/TelemetryRepository.ts</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { ReadableSpan } from '@opentelemetry/tracing';
import { SpanKind } from '@opentelemetry/api';
import { SemanticAttributes, MessagingOperationValues } from '@opentelemetry/semantic-conventions';
import { MalabiSpan } from './MalabiSpan';

/**
 * A Class that allows access of spans created in the test run. for example: HTTP GET spans. Mongo db spans, etc.
 * Read more about OpenTelemetry Spans [here]{@link https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/api.md#span}
 *
 */
class SpansRepository {
    readonly spans: ReadableSpan[];

    /**
     * Initializes the internal spans array.
     * @param spans An array of ReadableSpans
     */
    constructor(spans: ReadableSpan[]) {
        this.spans = spans;
    }

    /**
     * Filters the internal spans array according to the predicate.
     * Returns a new SpansRepository object to allow chaining.
     * @param predicate A predicate to filter the spans.
     */
    private filter(predicate: (span: ReadableSpan) => boolean): SpansRepository {
        return new SpansRepository(this.spans.filter(predicate));
    }

    /**
     * Returns how many spans are currently in the array.
     */
    get length() {
        return this.spans.length;
    }

    /**
     * Returns the first span as MalabiSpan.
     */
    get first() {
        if (this.spans.length &lt; 1) throw new Error(`Tried to get the "first" span, but there are no spans.`);
        return new MalabiSpan(this.spans[0]);
    }

    /**
     * Returns the second span as MalabiSpan.
     */
    get second() {
        if (this.spans.length &lt; 2)
            throw new Error(`Tried to get the "second" span, but there are only ${this.spans.length} spans.`);
        return new MalabiSpan(this.spans[1]);
    }

    /**
     * Returns all spans as MalabiSpan.
     */
    get all(): MalabiSpan[] {
        return this.spans.map((s) => new MalabiSpan(s));
    }

    /**
     * Returns span at the given index as MalabiSpan.
     * @param index The index to retrieve.
     */
    at(index: number) {
        if (this.spans.length &lt; index + 1)
            throw new Error(`Tried to get the span in ${index} index, but there are only ${this.spans.length} spans.`);
        return new MalabiSpan(this.spans[index]);
    }

    /**
     * Returns a new instance of SpansRepository with only HTTP spans.
     */
    http() {
        return this.filter((span) => Boolean(span.attributes[SemanticAttributes.HTTP_METHOD]));
    }

    /**
     * Returns a new instance of SpansRepository with only HTTP spans, filtered by method.
     * @param The method to filter by. GET,POST, etc.
     */
    httpMethod(method: string) {
        return this.filter(
            (span) =>
                (span.attributes[SemanticAttributes.HTTP_METHOD] as string)?.toLowerCase() === method.toLowerCase()
        );
    }


    /**
     * Returns a new instance of SpansRepository with only HTTP GET spans.
     */
    httpGet() {
        return this.filter(
            (span) => (span.attributes[SemanticAttributes.HTTP_METHOD] as string)?.toLowerCase() === 'get'
        );
    }

    /**
     * Returns a new instance of SpansRepository with only HTTP POST spans.
     */
    httpPost() {
        return this.filter(
            (span) => (span.attributes[SemanticAttributes.HTTP_METHOD] as string)?.toLowerCase() === 'post'
        );
    }

    /**
     * Returns a new instance of SpansRepository with only HTTP spans that have a specific route
     * @param r The route to filter by.
     */
    route(r: string | RegExp) {
        return this.filter((span) => {
            const route = span[SemanticAttributes.HTTP_ROUTE] as string;
            return typeof r === 'string' ? route?.toLowerCase() === r.toLowerCase() : r.test(route);
        });
    }

    /**
     * Returns a new instance of SpansRepository with only HTTP spans that have a specific path
     * @param p The path to filter by.
     */
    path(p: string | RegExp) {
        return this.filter((span) => {
            const path = span.attributes['http.path'] as string;
            return typeof p === 'string' ? path?.toLowerCase() === p.toLowerCase() : p.test(path);
        });
    }

    /**
     * Returns a new instance of SpansRepository with only messaging spans with the following kind: producer.
     */
    messagingSend() {
        return this.filter((span) => span.kind === SpanKind.PRODUCER);
    }

    /**
     * Returns a new instance of SpansRepository with only messaging spans with the following MESSAGING_OPERATION: receive.
     */
    messagingReceive() {
        return this.filter(
            (span) => span.attributes[SemanticAttributes.MESSAGING_OPERATION] === MessagingOperationValues.RECEIVE
        );
    }

    /**
     * Returns a new instance of SpansRepository with only messaging spans with the following MESSAGING_OPERATION: process.
     */
    messagingProcess() {
        return this.filter(
            (span) => span.attributes[SemanticAttributes.MESSAGING_OPERATION] === MessagingOperationValues.PROCESS
        );
    }


    /**
     * Returns a new instance of SpansRepository with SQS spans only.
     */
    awsSqs() {
        return this.filter((span) => span.attributes[SemanticAttributes.RPC_SERVICE] === 'sqs');
    }

    /**
     * Returns a new instance of SpansRepository with the entry span only (meaning without parent span id).
     */
    entry() {
        return this.filter((span) => !span.parentSpanId);
    }

    /**
     * Returns a new instance of SpansRepository mongo db spans only.
     */
    mongo() {
        return this.filter((span) => span.attributes[SemanticAttributes.DB_SYSTEM] === 'mongodb');
    }

    /**
     * Returns a new instance of SpansRepository with incoming spans only.
     */
    incoming() {
        return this.filter((span) => span.kind === SpanKind.SERVER);
    }

    /**
     * Returns a new instance of SpansRepository with outgoing spans only.
     */
    outgoing() {
        return this.filter((span) => span.kind === SpanKind.CLIENT);
    }

    /**
     * Returns a new instance of SpansRepository with express spans only.
     */
    express() {
        return this.filter((span) => span.instrumentationLibrary.name.includes('express'));
    }

    /**
     * Returns a new instance of SpansRepository with TypeORM spans only.
     */
    typeorm() {
        return this.filter((span) => span.instrumentationLibrary.name.includes('typeorm'));
    }

    /**
     * Returns a new instance of SpansRepository with sequelize spans only.
     */
    sequelize() {
        return this.filter((span) => span.instrumentationLibrary.name.includes('sequelize'));
    }

    /**
     * Returns a new instance of SpansRepository with Neo4j spans only.
     */
    neo4j() {
        return this.filter((span) => span.instrumentationLibrary.name.includes('neo4j'));
    }

    /**
     * Returns a new instance of SpansRepository with database spans only.
     */
    database() {
        return this.filter((span) => Boolean(span.attributes[SemanticAttributes.DB_SYSTEM]));
    }

    /**
     * Returns a new instance of SpansRepository with database spans that match a given operation.
     * @param op The operation to filter by. For example: "save".
     */
    dbOperation(op: string) {
        return this.filter(
            (span) => (span.attributes[SemanticAttributes.DB_OPERATION] as string)?.toLowerCase() === op.toLowerCase()
        );
    }

    /**
     * Returns a new instance of SpansRepository with messaging spans only.
     */
    messaging() {
        return this.filter((span) => Boolean(span.attributes[SemanticAttributes.MESSAGING_SYSTEM]));
    }

    /**
     * Returns a new instance of SpansRepository with rpc spans only.
     */
    rpc() {
        return this.filter((span) => Boolean(span.attributes[SemanticAttributes.RPC_SYSTEM]));
    }

    /**
     * Returns a new instance of SpansRepository with AWS spans only.
     */
    aws() {
        return this.filter((span) => span.attributes[SemanticAttributes.RPC_SYSTEM] === 'aws-api');
    }
}

/**
 * A Class that allows access of telemetry from the test run. for example: HTTP GET spans. Mongo db spans, etc.
 *
 * Read more about OpenTelemetry [here]{@link https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/api.md}
 */
export class TelemetryRepository {
    private readonly spansRepository: SpansRepository;

    /**
     * Fetches the spans from the exposed malabi spans endpoint
     * @param spans An array of ReadableSpans
     */
    constructor(spans: ReadableSpan[]) {
        this.spansRepository = new SpansRepository(spans);
    }

    /**
     * Get the SpansRepository object that allows you to do filtering on the spans. chaining is filters supported.
     */
    get spans() {
        return this.spansRepository;
    }
}

// initMalabiSpansWrapper / getMalabiSpansWrapper
export const initRepository = (spans: ReadableSpan[]) => new TelemetryRepository(spans);</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

<script src="scripts/search.js"> </script>

</body>
</html>
